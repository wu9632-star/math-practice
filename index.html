<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å‡æ¯«å‡å­¸ç¿’æ¨‚åœ’ - å®Œæ•´ä¿®æ­£ç‰ˆ</title>
    <style>
        :root { --primary: #3498db; --secondary: #e67e22; --bg: #fdfaf2; --success: #27ae60; --error: #e74c3c; --convert: #1abc9c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .app-container { width: 100%; max-width: 550px; text-align: center; }
        #home-screen { display: block; }
        #main-practice-area { display: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-weight: bold; color: var(--primary); font-size: 18px; }
        .menu-title { font-weight: bold; color: #444; margin: 15px 0 5px; text-align: left; border-left: 5px solid var(--primary); padding-left: 10px; font-size: 18px; }
        .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { padding: 12px; font-size: 15px; cursor: pointer; border: 2px solid #ddd; border-radius: 12px; background: white; font-weight: bold; color: #777; transition: 0.2s; }
        .menu-btn.selected { color: white; transform: scale(1.03); border-width: 3px; }
        .btn-conv.selected { background-color: var(--convert); border-color: #16a085; }
        .btn-calc.selected { background-color: var(--primary); border-color: #2980b9; }
        .box-container { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 25px 0; font-size: 24px; font-weight: bold; }
        .digit-input { width: 42px; height: 55px; font-size: 30px; text-align: center; border: 2px solid #ccc; border-radius: 8px; background: #fffde7; }
        .unit-input { width: 90px; height: 45px; font-size: 22px; text-align: center; border: 2px solid #ccc; border-radius: 8px; }
        .vertical-calc { display: grid; grid-template-columns: 40px 110px 130px; font-size: 26px; line-height: 60px; margin: 20px auto; width: fit-content; }
        .unit-label { text-align: center; font-size: 18px; border-bottom: 2px solid #ccc; font-weight: bold; }
        .calc-input { width: 100px; font-size: 26px; text-align: right; border: 2px solid #ccc; border-radius: 8px; padding: 5px; background: #fffde7; }
        .line { grid-column: 1 / 4; border-bottom: 3px solid #333; margin: 10px 0; }
        .action { padding: 12px 25px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; margin: 5px; }
        .start-action { background: #2ecc71; width: 90%; font-size: 22px; padding: 15px; border-radius: 50px; border: none; color: white; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="home-screen">
        <h1>ğŸ’§ å…¬å‡æ¯«å‡å­¸ç¿’æ¨‚åœ’</h1>
        <div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #ddd;">
            <span style="font-weight:bold;">è¨ˆç®—é¡Œå…¬å‡ä¸Šé™ï¼š<span id="rangeDisplay" style="color:var(--primary)">20</span> L</span><br>
            <input type="range" id="maxLRange" min="20" max="100" value="20" step="10" style="width:85%" oninput="document.getElementById('rangeDisplay').innerText=this.value">
        </div>
        <div class="menu-title">å–®å…ƒä¸€ï¼šå–®ä½æ›ç®—</div>
        <div class="menu">
            <button class="menu-btn btn-conv" id="t-c-01" onclick="toggleType('c-01')">0-1 å…¬å‡æ›æ¯«å‡(æ•´åƒ)</button>
            <button class="menu-btn btn-conv" id="t-c-02" onclick="toggleType('c-02')">0-2 æ¯«å‡æ›å…¬å‡(æ•´åƒ)</button>
            <button class="menu-btn btn-conv" id="t-c-11" onclick="toggleType('c-11')">1-1 çµ„åˆå‹(åˆç´š)</button>
            <button class="menu-btn btn-conv" id="t-c-12" onclick="toggleType('c-12')">1-2 çµ„åˆå‹(é€²éš)</button>
            <button class="menu-btn btn-conv" id="t-c-21" onclick="toggleType('c-21')">2-1 æ‹†è§£å‹(åˆç´š)</button>
            <button class="menu-btn btn-conv" id="t-c-22" onclick="toggleType('c-22')">2-2 æ‹†è§£å‹(é€²éš)</button>
        </div>
        <div class="menu-title">å–®å…ƒäºŒï¼šåŠ æ¸›è¨ˆç®—</div>
        <div class="menu">
            <button class="menu-btn btn-calc" id="t-a-0" onclick="toggleType('a-0')">1-1 åŠ æ³•(ç°¡å–®)</button>
            <button class="menu-btn btn-calc" id="t-s-0" onclick="toggleType('s-0')">2-1 æ¸›æ³•(ç°¡å–®)</button>
            <button class="menu-btn btn-calc" id="t-a-1" onclick="toggleType('a-1')">1-2 åŠ æ³•(ä¸­ç­‰)</button>
            <button class="menu-btn btn-calc" id="t-s-1" onclick="toggleType('s-1')">2-2 æ¸›æ³•(ä¸­ç­‰)</button>
            <button class="menu-btn btn-calc" id="t-a-2" onclick="toggleType('a-2')">1-3 åŠ æ³•(å›°é›£)</button>
            <button class="menu-btn btn-calc" id="t-s-2" onclick="toggleType('s-2')">2-3 æ¸›æ³•(å›°é›£)</button>
        </div>
        <button class="start-action" id="startBtn" disabled onclick="startApp()">é–‹å§‹ç·´ç¿’</button>
    </div>

    <div id="main-practice-area">
        <div class="stats-grid">
            <div class="stat-item">ç¸½é¡Œæ•¸ï¼š<span id="stat-total" class="stat-value">0</span></div>
            <div class="stat-item">ä¸€æ¬¡å°±å°ï¼š<span id="stat-perfect" class="stat-value">0</span></div>
            <div class="stat-value" style="grid-column: 1/3; color:var(--error); font-size:20px; border-top:1px solid #eee; padding-top:10px;">
                ç¬¬ä¸€æ¬¡ç­”å°ç‡ï¼š<span id="stat-accuracy">0</span>%
            </div>
        </div>
        <div id="convert-screen" style="display:none; background:white; padding:30px; border-radius:20px;">
            <div id="conv-q-text" style="font-size:24px; font-weight:bold; margin-bottom:15px;"></div>
            <div class="box-container" id="conv-input-area"></div>
            <button class="action" style="background:var(--secondary);" id="conv-check" onclick="checkConvert()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="action" style="background:var(--primary); display:none;" id="conv-next" onclick="generateQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="practice-screen" style="display:none; background:white; padding:20px; border-radius:20px;">
            <div id="calc-q-text" style="font-size:18px; font-weight:bold; margin-bottom:15px; background:#eef7ff; padding:10px; border-radius:8px;"></div>
            <div class="vertical-calc">
                <div class="unit-label"></div><div class="unit-label">å…¬å‡</div><div class="unit-label">æ¯«å‡</div>
                <div></div><div><input type="number" class="calc-input" id="ansL1"></div><div><input type="number" class="calc-input" id="ansMl1"></div>
                <div id="op-display" style="font-weight:bold; text-align:left;">+</div>
                <div><input type="number" class="calc-input" id="ansL2"></div><div><input type="number" class="calc-input" id="ansMl2"></div>
                <div class="line"></div>
                <div style="font-weight:bold; text-align:left;">=</div>
                <div><input type="number" class="calc-input" id="finalL"></div><div><input type="number" class="calc-input" id="finalMl"></div>
            </div>
            <button class="action" style="background:var(--secondary);" id="calc-check" onclick="checkCalc()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="action" style="background:var(--primary); display:none;" id="calc-next" onclick="generateQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="feedback" style="margin-top:20px; font-size:22px; font-weight:bold; min-height:30px;"></div>
        <button class="action" style="background:#95a5a6; margin-top:30px;" onclick="location.reload()">ğŸ  å›é¦–é </button>
    </div>
</div>

<script>
    let selectedTypes = [];
    let stats = { total: 0, perfect: 0 };
    let correctData = {};
    let isFirstTry = true;

    function toggleType(type) {
        const btn = document.getElementById('t-' + type);
        if (selectedTypes.includes(type)) {
            selectedTypes = selectedTypes.filter(t => t !== type);
            btn.classList.remove('selected');
        } else {
            selectedTypes.push(type);
            btn.classList.add('selected');
        }
        document.getElementById('startBtn').disabled = selectedTypes.length === 0;
    }

    function startApp() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('main-practice-area').style.display = 'block';
        generateQuestion();
    }

    function generateQuestion() {
        isFirstTry = true;
        document.getElementById('feedback').innerText = "";
        const type = selectedTypes[Math.floor(Math.random() * selectedTypes.length)];
        
        if (type.startsWith('c')) {
            document.getElementById('convert-screen').style.display = 'block';
            document.getElementById('practice-screen').style.display = 'none';
            document.getElementById('conv-check').style.display = 'inline-block';
            document.getElementById('conv-next').style.display = 'none';
            setupConvertQuestion(type);
        } else {
            document.getElementById('convert-screen').style.display = 'none';
            document.getElementById('practice-screen').style.display = 'block';
            document.getElementById('calc-check').style.display = 'inline-block';
            document.getElementById('calc-next').style.display = 'none';
            setupCalcQuestion(type);
        }
// --- ä»¥ä¸‹æ˜¯æ–°åŠ å…¥çš„è‡ªå‹•è·³æ ¼åµæ¸¬ ---
        setTimeout(() => {
            // æŠ“å–ç•«é¢ä¸Šæ‰€æœ‰çš„è¼¸å…¥æ¡†ï¼ˆæ›ç®—çš„æ•¸å­—æ ¼ã€å–®ä½çš„æ•¸å­—æ ¼ã€ç›´å¼çš„æ•¸å­—æ ¼ï¼‰
            const allInputs = document.querySelectorAll('.digit-input');
            allInputs.forEach((input, index) => {
                input.oninput = function() {
                    // å¦‚æœè¼¸å…¥äº†æ•¸å­—ï¼Œä¸”ä¸æ˜¯æœ€å¾Œä¸€æ ¼ï¼Œå°±è‡ªå‹•èšç„¦åˆ°ä¸‹ä¸€æ ¼
                    if (this.value.length >= (this.maxLength || 1) && index < allInputs.length - 1) {
                        allInputs[index + 1].focus();
                    }
                };
            });
        }, 100); // ç¨å¾®å»¶é²ç¢ºä¿é¡Œç›®æ ¼å­éƒ½é•·å‡ºä¾†äº†
    }

    function setupConvertQuestion(type) {
        const area = document.getElementById('conv-input-area');
        const qText = document.getElementById('conv-q-text');
        area.innerHTML = "";
        let l, ml, total;
        switch(type) {
            case 'c-01': l = r(1, 9); qText.innerText = `${l} å…¬å‡ = ? æ¯«å‡`; createDigitInputs(4, area); correctData = { mode: 'digits', val: (l*1000).toString() }; break;
            case 'c-02': l = r(1, 9); qText.innerText = `${l*1000} æ¯«å‡ = ? å…¬å‡`; area.innerHTML = `<input type="number" id="c-l" class="unit-input"> å…¬å‡`; correctData = { mode: 'units', l: l, ml: 0 }; break;
            case 'c-11': l = r(1, 9); ml = r(111, 999); qText.innerText = `${l} å…¬å‡ ${ml} æ¯«å‡ = ? æ¯«å‡`; createDigitInputs(4, area); correctData = { mode: 'digits', val: (l*1000+ml).toString() }; break;
            case 'c-12': l = r(1, 9); ml = r(1, 99); qText.innerText = `${l} å…¬å‡ ${ml} æ¯«å‡ = ? æ¯«å‡`; createDigitInputs(4, area); correctData = { mode: 'digits', val: (l*1000+ml).toString().padStart(4,'0') }; break;
            case 'c-21': total = r(1,9)*1000 + r(111,999); qText.innerText = `${total} æ¯«å‡ = ? å…¬å‡ ? æ¯«å‡`; area.innerHTML = `<input type="number" id="c-l" class="unit-input"> å…¬å‡ <input type="number" id="c-ml" class="unit-input"> æ¯«å‡`; correctData = { mode: 'units', l: Math.floor(total/1000), ml: total%1000 }; break;
            case 'c-22': total = r(1,9)*1000 + r(1,99); qText.innerText = `${total} æ¯«å‡ = ? å…¬å‡ ? æ¯«å‡`; area.innerHTML = `<input type="number" id="c-l" class="unit-input"> å…¬å‡ <input type="number" id="c-ml" class="unit-input"> æ¯«å‡`; correctData = { mode: 'units', l: Math.floor(total/1000), ml: total%1000 }; break;
        }
    }

    function createDigitInputs(num, container) {
        for (let i = 0; i < num; i++) {
            let input = document.createElement('input'); input.type = "text"; input.inputMode = "numeric"; input.maxLength = 1;
            input.className = "digit-input"; input.id = "digit-" + i;
            input.oninput = function() { if (this.value && i < num - 1) document.getElementById("digit-" + (i + 1)).focus(); };
            input.onkeydown = function(e) { if (e.key === "Backspace" && !this.value && i > 0) document.getElementById("digit-" + (i - 1)).focus(); };
            container.appendChild(input);
        }
        container.innerHTML += " æ¯«å‡";
    }

    function setupCalcQuestion(type) {
        document.querySelectorAll('.calc-input').forEach(i => { i.value = ""; i.style.borderColor = "#ccc"; });
        const maxLimit = parseInt(document.getElementById('maxLRange').value);
        let l1, l2, ml1, ml2, op;

        if (type.startsWith('a')) {
            op = "+";
            if (type === 'a-0') { // 0-1 ä¸é€²ä½ (10Lå…§)
                l1 = r(1, 4); l2 = r(1, 4); 
                let res = getSimpleNums(true); ml1 = res[0]; ml2 = res[1];
            } else if (type === 'a-1') { // 1-1 ä¸é€²ä½ (è¶…é10L)
                l1 = r(6, maxLimit/2); l2 = r(6, maxLimit/2);
                let res = getSimpleNums(true); ml1 = res[0]; ml2 = res[1];
            } else if (type === 'a-2') { // 1-2 é€²ä½
                l1 = r(5, maxLimit/2); l2 = r(5, maxLimit/2);
                ml1 = r(600, 950); ml2 = r(600, 950);
            }
        } else {
            op = "-";
            if (type === 's-0') { // 0-2 ä¸é€€ä½ (10Lå…§)
                l1 = r(6, 9); l2 = r(1, 4);
                let res = getSimpleNums(false); ml1 = res[0]; ml2 = res[1];
            } else if (type === 's-1') { // 2-1 ä¸é€€ä½ (è¶…é10L)
                l1 = r(maxLimit/2 + 5, maxLimit); l2 = r(5, maxLimit/2);
                let res = getSimpleNums(false); ml1 = res[0]; ml2 = res[1];
            } else if (type === 's-2') { // 2-2 é€€ä½
                l1 = r(maxLimit/2 + 5, maxLimit); l2 = r(5, maxLimit/2);
                ml1 = r(100, 400); ml2 = r(600, 950);
            }
        }

        document.getElementById('op-display').innerText = op;
        let t1 = l1 * 1000 + ml1, t2 = l2 * 1000 + ml2;
        let finalVal = (op === "+") ? t1 + t2 : t1 - t2;
        document.getElementById('calc-q-text').innerText = `${l1}å…¬å‡${ml1}æ¯«å‡ ${op} ${Math.floor(t2/1000)}å…¬å‡${t2%1000}æ¯«å‡ = ?`;
        correctData = { ansL1: l1, ansMl1: ml1, ansL2: Math.floor(t2/1000), ansMl2: t2%1000, finalL: Math.floor(finalVal/1000), finalMl: finalVal%1000 };
    }

    function getSimpleNums(isAdd) {
        let a = "", b = "";
        for(let i=0; i<3; i++) {
            let d1 = r(1, 4);
            let d2 = isAdd ? r(1, 4) : r(1, d1);
            a += d1; b += d2;
        }
        return [parseInt(a), parseInt(b)];
    }

    function checkConvert() {
        let ok = true;
        if (correctData.mode === 'digits') {
            for (let i = 0; i < 4; i++) {
                let el = document.getElementById('digit-' + i);
                if (el.value === correctData.val[i]) el.style.borderColor = "var(--success)";
                else { el.style.borderColor = "var(--error)"; ok = false; }
            }
        } else {
            let lEl = document.getElementById('c-l'), mlEl = document.getElementById('c-ml');
            if (parseInt(lEl.value) === correctData.l) lEl.style.borderColor = "var(--success)";
            else { lEl.style.borderColor = "var(--error)"; ok = false; }
            if (mlEl) {
                if (parseInt(mlEl.value) === correctData.ml) mlEl.style.borderColor = "var(--success)";
                else { mlEl.style.borderColor = "var(--error)"; ok = false; }
            }
        }
        processResult(ok, 'conv');
    }

    function checkCalc() {
        let ok = true;
        for (let key in correctData) {
            let el = document.getElementById(key);
            if (parseInt(el.value) === correctData[key]) el.style.borderColor = "var(--success)";
            else { el.style.borderColor = "var(--error)"; ok = false; }
        }
        processResult(ok, 'calc');
    }

    function processResult(isCorrect, mode) {
        if (isFirstTry) { stats.total++; if (isCorrect) stats.perfect++; isFirstTry = false; }
        updateStats();
        let fb = document.getElementById('feedback');
        if (isCorrect) {
            fb.innerText = "â­• å¤ªæ£’äº†ï¼å®Œå…¨æ­£ç¢ºï¼"; fb.style.color = "var(--success)";
            document.getElementById(mode + '-check').style.display = 'none';
            document.getElementById(mode + '-next').style.display = 'inline-block';
        } else {
            fb.innerText = "âŒ é‚„æœ‰æ ¼å­ä¸å°å–”ï¼Œå†æª¢æŸ¥ä¸€æ¬¡ï¼"; fb.style.color = "var(--error)";
        }
    }

    function updateStats() {
        document.getElementById('stat-total').innerText = stats.total;
        document.getElementById('stat-perfect').innerText = stats.perfect;
        let acc = (stats.total === 0) ? 0 : Math.round((stats.perfect / stats.total) * 100);
        document.getElementById('stat-accuracy').innerText = acc;
    }

    function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
</script>
</body>
</html>
