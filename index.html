<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å‡æ¯«å‡å­¸ç¿’æ¨‚åœ’ - å¼·åŒ–é€²ä½ç‰ˆ</title>
    <style>
        :root { --primary: #3498db; --secondary: #e67e22; --bg: #fdfaf2; --success: #27ae60; --error: #e74c3c; --convert: #1abc9c; --advanced: #c0392b; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .app-container { width: 100%; max-width: 550px; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-weight: bold; color: var(--primary); font-size: 18px; }
        .menu-title { font-weight: bold; color: #444; margin: 15px 0 5px; text-align: left; border-left: 5px solid var(--primary); padding-left: 10px; font-size: 18px; }
        .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { padding: 8px; font-size: 14px; cursor: pointer; border: 2px solid #ddd; border-radius: 12px; background: white; font-weight: bold; color: #777; transition: 0.2s; height: 60px;}
        .menu-btn.selected { color: white; transform: scale(1.03); border-width: 3px; }
        .btn-conv.selected { background-color: var(--convert); border-color: #16a085; }
        .btn-calc.selected { background-color: var(--primary); border-color: #2980b9; }
        .mode-selector { display: flex; gap: 10px; margin: 15px 0; }
        .mode-btn { flex: 1; padding: 15px; border: 3px solid #ddd; border-radius: 15px; cursor: pointer; font-size: 18px; font-weight: bold; background: white; transition: 0.3s; }
        .mode-btn.active { border-color: var(--success); background: #e8f5e9; color: var(--success); }
        .mode-btn.active.adv { border-color: var(--advanced); background: #f9ebea; color: var(--advanced); }
        .box-container { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 25px 0; font-size: 24px; font-weight: bold; }
        .digit-input { width: 42px; height: 55px; font-size: 30px; text-align: center; border: 2px solid #ccc; border-radius: 8px; background: #fffde7; }
        .single-input { width: 180px; height: 55px; font-size: 30px; text-align: center; border: 2px solid #ccc; border-radius: 8px; background: #fffde7; letter-spacing: 2px; }
        .unit-input { width: 80px; height: 45px; font-size: 22px; text-align: center; border: 2px solid #ccc; border-radius: 8px; }
        .vertical-calc { display: grid; grid-template-columns: 40px 110px 130px; font-size: 26px; line-height: 60px; margin: 20px auto; width: fit-content; }
        .unit-label {
    text-align: center;
    font-size: 18px;
    border-bottom: 2px solid #ccc;
    font-weight: bold;
    transition: padding 0.3s; /* è®“ç§»å‹•æ™‚æœ‰å€‹å¹³æ»‘æ„Ÿ */}
         .adv-sub-layout .unit-label {
    padding-bottom: 50px; /* æŠŠå­—æ¨é«˜ï¼Œç©ºå‡ºä½ç½®çµ¦å…©æ’è¼”åŠ©æ ¼ */
}
         .adv-sub-layout .calc-row {
    margin-top: 60px !important;
}
/* 1. #ansMl1, #ansMl2, #finalMl {
    background-image: linear-gradient(to right, #ccc 1px, transparent 1px) !important;
    background-size: 33.3% 100% !important;
    background-repeat: repeat-x !important;
    background-color: #fffde7 !important;
    font-family: 'Courier New', Courier, monospace !important;
    letter-spacing: 8px !important;
    text-align: right !important;
    padding-right: 12px !important;
    width: 100px; /* ç¢ºä¿å¯¬åº¦å›ºå®š */
    font-size: 26px;
    border: 2px solid #ccc;
    border-radius: 8px;
}

/* 2. ä¿®æ­£å–®ä½æ¨™ç±¤åœ¨é€²éšæ¨¡å¼çš„ä½ç§»ï¼ˆæ”¹ç”¨è¼ƒç©©å®šçš„æ–¹å¼ï¼‰ */
.adv-sub-layout .unit-label {
    position: relative;
    top: -45px;
}
        .calc-input { 
          width: 100px; 
          font-size: 26px;           /* 1. ä½¿ç”¨ç­‰å¯¬å­—é«”ï¼Œç¢ºä¿æ¯å€‹æ•¸å­—å¯¬åº¦ä¸€è‡´ */
          font-family: 'Courier New', Courier, monospace;       /* 2. æ‹‰å¤§å­—é«”é–“è·ï¼Œè®“æ•¸å­—ä¸è¦æ“ åœ¨ä¸€èµ· */
          letter-spacing: 10px; 
          text-align: right; 
          border: 2px solid #ccc; 
          border-radius: 8px;           /* 3. èª¿æ•´å…§é‚Šè·ï¼Œé…åˆå­—è·å¾Œçš„å°é½Š */
          padding: 5px 12px 5px 5px; 
      }
        .calc-row {    margin-top: 50px !important; /* å¢åŠ è¡Œèˆ‡è¡Œä¹‹é–“çš„è·é›¢ */    position: relative;}
        .line { grid-column: 1 / 4; border-bottom: 3px solid #333; margin: 10px 0; }
        .action { padding: 12px 25px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; margin: 5px; }
        .start-action { background: #2ecc71; width: 100%; font-size: 22px; padding: 15px; border-radius: 50px; border: none; color: white; cursor: pointer; margin-top: 10px; }
        
        /* è¼”åŠ©æ ¼é€šç”¨æ¨£å¼ */
        .assist-input { position: absolute; width: 30px !important; height: 20px !important; font-size: 12px !important; padding: 0 !important; text-align: center; border: 1px dashed var(--secondary) !important; background: #fffde7 !important; z-index: 10; border-radius: 4px; }
        .carry-pos { top: -15px; right: 5px; }
        .borrow-l-pos { top: -15px; right: 5px; }
      
        /* æ¯«å‡å…§éƒ¨çš„åä½ç™¾ä½é€²ä½æ ¼ */
        .ml-upper-100 { top: -48px; right: 80px; border-color: #95a5a6 !important; }
        .ml-upper-10  { top: -48px; right: 50px; border-color: #95a5a6 !important; }
        .ml-carry-1 { top: -25px; right: 20px; /* å¤§ç´„åœ¨åä½æ•¸ä¸Šæ–¹ */     }
        .ml-carry-10 { top: -25px; right: 50px; /* å¤§ç´„åœ¨åä½æ•¸ä¸Šæ–¹ */     }
        .ml-carry-100 { top: -25px; right: 80px; /* å¤§ç´„åœ¨ç™¾ä½æ•¸ä¸Šæ–¹ */     }
        /* åŠƒæ‰æ•¸å­—çš„å‹•æ…‹æ•ˆæœ */
#ansMl1, #ansL1 {
    position: relative;
}
/* --- 1. åŸºç¤æ ¼å­ï¼šåªä¿ç•™ç°è‰²è¼”åŠ©ç·š --- */
#ansL1, #ansL2, #finalL, #ansMl1, #ansMl2, #finalMl {
    background-color: #fffde7 !important;
    background-repeat: no-repeat !important;
    background-size: 100% 100% !important;
    background-image: 
        linear-gradient(to right, transparent 33.3%, #ddd 33.3%, #ddd 34.3%, transparent 34.3%),
        linear-gradient(to right, transparent 66.6%, #ddd 66.6%, #ddd 67.6%, transparent 67.6%) !important;
}
/* --- 1. æº–å‚™å¤–æ®¼ï¼šè®“å¤–æ®¼è®Šæˆå¯ä»¥è²¼è²¼ç´™çš„ç‹€æ…‹ --- */
.vertical-calc > div {
    position: relative; /* é€™è¡Œå°±åƒæ˜¯åœ¨å¤–æ®¼å¡—ä¸Šè† æ°´ï¼Œè®“è²¼ç´™èƒ½å›ºå®šä½ */
}

/* --- 2. ç™¾ä½è²¼ç´™ (before) --- */
.strike-hundreds::before {
    content: "";          /* å¿…é ˆæœ‰é€™è¡Œï¼Œè²¼ç´™æ‰æœƒå‡ºç¾ */
    position: absolute;   /* è®“è²¼ç´™å¯ä»¥è‡ªç”±ç§»å‹• */
    left: 15%;            /* è²¼åœ¨ç™¾ä½æ•¸çš„ä½ç½® */
    top: 15%;             /* è·é›¢é ‚ç«¯ä¸€é»é» */
    width: 2px;           /* ç´…ç·šçš„ç²—ç´° */
    height: 70%;          /* ç´…ç·šçš„é•·åº¦ */
    background: red;      /* ç´…ç·šçš„é¡è‰² */
    transform: rotate(25deg); /* è½‰å‹• 25 åº¦ï¼Œè®Šæ–œç·š */
    z-index: 5;           /* è®“ç´…ç·šç–Šåœ¨æ•¸å­—ä¸Šé¢ */
    pointer-events: none; /* è®“æ»‘é¼ é»æ“Šå¯ä»¥ç©¿éç´…ç·šï¼Œé»åˆ°å¾Œé¢çš„æ ¼å­ */
}

/* --- 3. åä½è²¼ç´™ (after) --- */
.strike-tens::after {
    content: "";
    position: absolute;
    left: 48%;            /* è²¼åœ¨åä½æ•¸çš„ä½ç½® */
    top: 15%;
    width: 2px;
    height: 70%;
    background: red;
    transform: rotate(25deg);
    z-index: 5;
    pointer-events: none;
}

/* å…¬å‡åŠƒç·š (æ–‡å­—åˆªé™¤ç·š) */
.strike-l {
    text-decoration: line-through solid red 4px !important;
}
</style>
</head>
<body>

<div class="app-container">
    <div id="home-screen">
        <h1>ğŸ’§ å…¬å‡æ¯«å‡å­¸ç¿’æ¨‚åœ’</h1>
        <div class="menu-title">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æ¨¡å¼</div>
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-basic" onclick="setMode('basic')">åŸºç¤æ¨¡å¼<br><small>< 10å…¬å‡</small></button>
            <button class="mode-btn" id="mode-adv" onclick="setMode('adv')">é€²éšæ¨¡å¼<br><small>> 10å…¬å‡</small></button>
        </div>
        <div id="adv-config" style="display:none; background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #ddd;">
            <span style="font-weight:bold;">é€²éšé¡Œå…¬å‡ä¸Šé™ï¼š<span id="rangeDisplay" style="color:var(--advanced)">50</span> L</span><br>
            <input type="range" id="maxLRange" min="20" max="100" value="50" step="10" style="width:85%" oninput="document.getElementById('rangeDisplay').innerText=this.value">
        </div>
        
        <div class="menu-title">å–®å…ƒä¸€ï¼šå–®ä½æ›ç®—</div>
        <div class="menu">
            <button class="menu-btn btn-conv" id="t-c-01" onclick="toggleType('c-01')">0-1 æ›æˆæ¯«å‡(ç°¡å–®)</button>
            <button class="menu-btn btn-conv" id="t-c-02" onclick="toggleType('c-02')">0-2 æ¯«å‡è½‰æ›(ç°¡å–®)</button>
            <button class="menu-btn btn-conv" id="t-c-11" onclick="toggleType('c-11')">1-1 æ›æˆæ¯«å‡(åˆç´š)</button>
            <button class="menu-btn btn-conv" id="t-c-21" onclick="toggleType('c-21')">2-1 æ¯«å‡è½‰æ›(åˆç´š)</button>
            <button class="menu-btn btn-conv" id="t-c-12" onclick="toggleType('c-12')">1-2 æ›æˆæ¯«å‡(é€²éš)</button>
            <button class="menu-btn btn-conv" id="t-c-22" onclick="toggleType('c-22')">2-2 æ¯«å‡è½‰æ›(é€²éš)</button>
        </div>

        <div class="menu-title">å–®å…ƒäºŒï¼šåŠ æ¸›è¨ˆç®—</div>
        <div class="menu">
            <button class="menu-btn btn-calc" id="t-a-0" onclick="toggleType('a-0')">1-1 åŠ æ³• (ç°¡å–®)</button>
            <button class="menu-btn btn-calc" id="t-s-0" onclick="toggleType('s-0')">2-1 æ¸›æ³• (ç°¡å–®)</button>
            <button class="menu-btn btn-calc" id="t-a-1" onclick="toggleType('a-1')">1-2 åŠ æ³• (ä¸­ç­‰)</button>
            <button class="menu-btn btn-calc" id="t-s-1" onclick="toggleType('s-1')">2-2 æ¸›æ³• (ä¸­ç­‰)</button>
        </div>
        <button class="start-action" id="startBtn" disabled onclick="startApp()">é–‹å§‹ç·´ç¿’</button>
    </div>

    <div id="main-practice-area" style="display:none;">
        <div class="stats-grid">
            <div class="stat-item">ç¸½é¡Œæ•¸ï¼š<span id="stat-total" class="stat-value">0</span></div>
            <div class="stat-item">ä¸€æ¬¡å°±å°ï¼š<span id="stat-perfect" class="stat-value">0</span></div>
            <div class="stat-value" style="grid-column: 1/3; color:var(--error); font-size:20px; border-top:1px solid #eee; padding-top:10px;">
                ç¬¬ä¸€æ¬¡ç­”å°ç‡ï¼š<span id="stat-accuracy">0</span>%
            </div>
        </div>
        <div id="convert-screen" style="display:none; background:white; padding:30px; border-radius:20px;">
            <div id="conv-q-text" style="font-size:24px; font-weight:bold; margin-bottom:15px;"></div>
            <div class="box-container" id="conv-input-area"></div>
            <button class="action" style="background:var(--secondary);" id="conv-check" onclick="checkConvert()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="action" style="background:var(--primary); display:none;" id="conv-next" onclick="generateQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="practice-screen" style="display:none; background:white; padding:20px; border-radius:20px;">
            <div id="calc-q-text" style="font-size:18px; font-weight:bold; margin-bottom:15px; background:#eef7ff; padding:10px; border-radius:8px;"></div>
            <div class="vertical-calc">
                <div class="unit-label"></div><div class="unit-label">å…¬å‡</div><div class="unit-label">æ¯«å‡</div>
                <div></div>
                <div style="position: relative;">
                    <input type="number" id="carry-box" class="assist-input carry-pos" style="display:none;" placeholder="+1">
                    <input type="number" class="calc-input" id="ansL1">
                </div>
                <div style="position: relative;">
                    <input type="number" id="ml-upper-100" class="assist-input ml-upper-100" style="display:none;">
                    <input type="number" id="ml-upper-10" class="assist-input ml-upper-10" style="display:none;">

                    <input type="number" id="ml-carry-100" class="assist-input ml-carry-100" style="display:none;" value="0">
                    <input type="number" id="ml-carry-10" class="assist-input ml-carry-10" style="display:none;" value="0">
                    <input type="number" id="ml-carry-1" class="assist-input ml-carry-1" style="display:none;" value="0">
                    <input type="number" class="calc-input" id="ansMl1">
                </div>
                <div id="op-display" style="font-weight:bold; text-align:left;">+</div>
                <div><input type="number" class="calc-input" id="ansL2"></div>
                <div><input type="number" class="calc-input" id="ansMl2"></div>
                <div class="line"></div>
                <div style="font-weight:bold; text-align:left;">=</div>
                <div><input type="number" class="calc-input" id="finalL"></div>
                <div><input type="number" class="calc-input" id="finalMl"></div>
            </div>
            <button class="action" style="background:var(--secondary);" id="calc-check" onclick="checkCalc()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="action" style="background:var(--primary); display:none;" id="calc-next" onclick="generateQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="feedback" style="margin-top:20px; font-size:22px; font-weight:bold; min-height:30px;"></div>
        <button class="action" style="background:#95a5a6; margin-top:30px;" onclick="location.reload()">ğŸ  å›é¦–é </button>
    </div>
</div>

<script>
    let selectedTypes = [];
    let stats = { total: 0, perfect: 0 };
    let correctData = {};
    let isFirstTry = true;
    let selectedModes = ['basic']; 
    let currentMode = 'basic';

    function setMode(mode) {
        const index = selectedModes.indexOf(mode);
        if (index > -1) {
            if (selectedModes.length > 1) selectedModes.splice(index, 1);
        } else {
            selectedModes.push(mode);
        }
        document.getElementById('mode-basic').classList.toggle('active', selectedModes.includes('basic'));
        document.getElementById('mode-adv').classList.toggle('active', selectedModes.includes('adv'));
        document.getElementById('mode-adv').classList.toggle('adv', selectedModes.includes('adv'));
        document.getElementById('adv-config').style.display = (selectedModes.includes('adv') ? 'block' : 'none');
    }

    function toggleType(type) {
        const btn = document.getElementById('t-' + type);
        if (selectedTypes.includes(type)) {
            selectedTypes = selectedTypes.filter(t => t !== type);
            btn.classList.remove('selected');
        } else {
            selectedTypes.push(type);
            btn.classList.add('selected');
        }
        document.getElementById('startBtn').disabled = selectedTypes.length === 0;
    }

    function startApp() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('main-practice-area').style.display = 'block';
        generateQuestion();
    }

function generateQuestion() {
        isFirstTry = true; 
        document.getElementById('feedback').innerText = "";

        // --- 1. ã€æ–°å¢ï¼šæ“¦é»‘æ¿ã€‘æ¸…ç©ºè¼”åŠ©æ ¼æ•¸å€¼èˆ‡é‚Šæ¡†é¡è‰² ---
        const allAssists = [
            document.getElementById('carry-box'),
            document.getElementById('ml-upper-100'),
            document.getElementById('ml-upper-10'),
            document.getElementById('ml-carry-100'),
            document.getElementById('ml-carry-10'),
            document.getElementById('ml-carry-1')
        ];
        allAssists.forEach(el => {
            if (el) {
                el.value = "";              
                el.style.borderColor = "#ccc"; 
            }
        });

        // --- 2. ã€æ–°å¢ï¼šæ’•æ‰è²¼ç´™ã€‘ç§»é™¤ç´…æ–œç·š ---
        const mlBox = document.getElementById('ansMl1');
        const lBox = document.getElementById('ansL1');
        if (mlBox) {
            // ç§»é™¤çˆ¶å±¤(å¤–æ®¼)çš„ç™¾ä½èˆ‡åä½ç´…ç·šé¡åˆ¥
            mlBox.parentElement.classList.remove('strike-hundreds', 'strike-tens');
            // ç§»é™¤å€‹ä½ç´…ç·š(å¦‚æœæœ‰)
            mlBox.classList.remove('strike-ones');
        }
        if (lBox) {
            lBox.classList.remove('strike-l');
        }
        // --- æ“¦é»‘æ¿å‹•ä½œçµæŸ ---

        currentMode = selectedModes[Math.floor(Math.random() * selectedModes.length)];
        const type = selectedTypes[Math.floor(Math.random() * selectedTypes.length)];
        
        if (type.startsWith('c')) {
            document.getElementById('convert-screen').style.display = 'block';
            document.getElementById('practice-screen').style.display = 'none';
            setupConvertQuestion(type);
        } else {
            document.getElementById('convert-screen').style.display = 'none';
            document.getElementById('practice-screen').style.display = 'block';
            setupCalcQuestion(type);
        }
        document.getElementById('conv-check').style.display = 'inline-block';
        document.getElementById('calc-check').style.display = 'inline-block';
        document.getElementById('conv-next').style.display = 'none';
        document.getElementById('calc-next').style.display = 'none';
    }
    function setupConvertQuestion(type) {
        const area = document.getElementById('conv-input-area');
        const qText = document.getElementById('conv-q-text');
        area.innerHTML = "";
        let l = (currentMode === 'basic') ? r(1, 9) : r(11, parseInt(document.getElementById('maxLRange').value));
        let ml, total;
        switch(type) {
            case 'c-01': 
                qText.innerText = `${l} å…¬å‡ = ? æ¯«å‡`; 
                total = (l * 1000).toString(); 
                if (currentMode === 'basic') createDigitInputs(4, area); 
                else area.innerHTML = `<input type="number" id="c-ml-single" class="single-input"> æ¯«å‡`; 
                correctData = { mode: (currentMode === 'basic'?'digits':'single'), val: total }; 
                break;
            case 'c-02': 
                qText.innerText = `${l * 1000} æ¯«å‡ = ? å…¬å‡`; 
                area.innerHTML = `<input type="number" id="c-l" class="unit-input"> å…¬å‡`; 
                correctData = { mode: 'units', l: l, ml: 0 }; 
                break;
            case 'c-11': case 'c-12': 
                ml = (type === 'c-11') ? r(111, 999) : r(1, 99); 
                qText.innerText = `${l} å…¬å‡ ${ml} æ¯«å‡ = ? æ¯«å‡`; 
                total = (l * 1000 + ml).toString(); 
                if (currentMode === 'basic') createDigitInputs(4, area); 
                else area.innerHTML = `<input type="number" id="c-ml-single" class="single-input"> æ¯«å‡`; 
                correctData = { mode: (currentMode === 'basic'?'digits':'single'), val: total.padStart(4, '0') }; 
                break;
            case 'c-21': case 'c-22': 
                ml = (type === 'c-21') ? r(111, 999) : r(1, 99); 
                total = l * 1000 + ml; 
                qText.innerText = `${total} æ¯«å‡ = ? å…¬å‡ ? æ¯«å‡`; 
                area.innerHTML = `<input type="number" id="c-l" class="unit-input"> å…¬å‡ <input type="number" id="c-ml" class="unit-input"> æ¯«å‡`; 
                correctData = { mode: 'units', l: l, ml: ml }; 
                break;
        }
    }

    function createDigitInputs(num, container) {
        container.innerHTML = "";
        for (let i = 0; i < num; i++) {
            let input = document.createElement('input'); 
            input.type = "text"; input.inputMode = "numeric"; input.maxLength = 1;
            input.className = "digit-input"; input.id = "digit-" + i;
            container.appendChild(input);
        }
        container.innerHTML += " æ¯«å‡";
        setTimeout(() => {
            const digitInputs = document.querySelectorAll('.digit-input');
            digitInputs.forEach((input, index) => {
                input.oninput = function() {
                    if (this.value.length >= 1 && index < digitInputs.length - 1) digitInputs[index+1].focus();
                };
            });
        }, 50);
    }

function setupCalcQuestion(type) {
    const mlBox = document.getElementById('ansMl1');
    const lBox = document.getElementById('ansL1');
    const cBox = document.getElementById('carry-box');
    const mc100 = document.getElementById('ml-carry-100');
    const mc10 = document.getElementById('ml-carry-10');
    const mc1 = document.getElementById('ml-carry-1');
    const up100 = document.getElementById('ml-upper-100');
    const up10 = document.getElementById('ml-upper-10');
    
    // ç²å–æœ€å¤–å±¤å®¹å™¨ï¼Œç”¨ä¾†åˆ‡æ›ä½ˆå±€æ¨£å¼
    const calcContainer = document.querySelector('.vertical-calc');

    // 1. åˆå§‹åŒ–æ‰€æœ‰è¼¸å…¥æ¡†èˆ‡åŠƒç·šæ¨£å¼
    document.querySelectorAll('.calc-input').forEach(i => { 
        i.value = ""; 
        i.style.borderColor = "#ccc"; 
        i.classList.remove('strikethrough', 'strike-l', 'strike-hundreds', 'strike-tens', 'strike-ones'); 
    });

    let op = type.startsWith('a') ? "+" : "-";
    const maxLimit = (currentMode === 'basic') ? 9 : parseInt(document.getElementById('maxLRange').value);
    let l1, l2, ml1, ml2;
    let isAdvanced = !(type === 'a-0' || type === 's-0'); 

    // --- é—œéµåˆ¤æ–·ï¼šæ˜¯å¦ç‚ºé€²éšæ¸›æ³• ---
    const isAdvSub = (isAdvanced && op === "-");

    // 2. ä½ˆå±€åˆ‡æ›ï¼šåªæœ‰é€²éšæ¸›æ³•æ‰åŠ ä¸Šç‰¹æ®Šçš„æ¨£å¼æ¨™ç±¤
    if (isAdvSub) {
        calcContainer.classList.add('adv-sub-layout');
    } else {
        calcContainer.classList.remove('adv-sub-layout');
    }

    // é¡Œç›®æ•¸å­—ç”Ÿæˆé‚è¼¯ (ä¿æŒä¸è®Š)
    if (!isAdvanced) { 
        let res = getSimpleNums(op === "+"); ml1 = res[0]; ml2 = res[1];
    } else {
        if (op === "+") { ml1 = r(1, 999); ml2 = r(1000 - ml1, 999); } 
      else { ml2 = r(1, 999); ml1 = r(0, ml2 - 1); }
    }
    if (op === "+") {
        let carry = (ml1 + ml2 >= 1000) ? 1 : 0;
        l1 = r(0, maxLimit - carry); l2 = r(0, maxLimit - l1 - carry);
    } else {
        let borrow = (ml1 < ml2) ? 1 : 0;
        l2 = r(0, maxLimit - borrow); l1 = r(l2 + borrow, maxLimit);
    }

    let t1 = l1 * 1000 + ml1, t2 = l2 * 1000 + ml2;
    let finalVal = (op === "+") ? t1 + t2 : t1 - t2;
    
    document.getElementById('op-display').innerText = op;
    document.getElementById('calc-q-text').innerText = `${l1}å…¬å‡${ml1}æ¯«å‡ ${op} ${l2}å…¬å‡${ml2}æ¯«å‡ = ?`;
    
    correctData = { ansL1: l1, ansMl1: ml1, ansL2: l2, ansMl2: ml2, finalL: Math.floor(finalVal/1000), finalMl: finalVal%1000 };

    // 3. è¼”åŠ©æ ¼åˆå§‹åŒ– (å…¨éƒ¨å…ˆè—èµ·ä¾†)
    [cBox, mc100, mc10, mc1, up100, up10].forEach(el => { 
        if(el) { 
            el.style.display = 'none'; 
            el.value = ""; 
            el.type = "number"; // ç¢ºä¿æ˜¯æ•¸å­—å‹æ…‹
            el.min = "0";       // é™åˆ¶æœ€å°å€¼ç‚º 0
            el.oninput = null;
            el.onfocus = null;
            el.style.borderColor = "#ccc";
        }
    });

    // 4. é€²éšæ¨¡å¼é€£å‹•é‚è¼¯
    if (isAdvanced) {
        // åŠ æ³•é€²éšåªé¡¯å…¬å‡æ ¼ï¼›æ¸›æ³•é€²éšé¡¯ç¤ºå…¨éƒ¨
        cBox.style.display = 'block';
        cBox.value = (op === "-") ? "0" : "0";
    // 2. æ¯«å‡é€²ä½æ ¼ï¼šåŠ æ³•åªéœ€è¦ã€Œé€²ç™¾ä½ã€å’Œã€Œé€²åä½ã€
        // mc100 æ˜¯åœ¨ç™¾ä½ä¸Šæ–¹ï¼Œmc10 æ˜¯åœ¨åä½ä¸Šæ–¹
        [mc100, mc10].forEach(el => { if(el) el.style.display = 'block'; });
        if (op === "-") {
            // é¡¯ç¤ºå…©å±¤æ¯«å‡è¼”åŠ©æ ¼
            [up100, up10, mc100, mc10, mc1].forEach(el => { if(el) el.style.display = 'block'; });

            // (A) å…¬å‡åŠƒç·š
            cBox.oninput = () => { lBox.classList.toggle('strike-l', cBox.value !== "0"); };

            // (B) é»æ“Šè‡ªå‹•è®Š 10
            [up100, up10, mc1].forEach(h => {
                if(h) {
                    h.onfocus = function() {
                        if (this.value === "" || this.value === "0") { 
                            this.value = "10";
                            this.dispatchEvent(new Event('input'));
                        }
                    };
                }
            });

            // (C) ç²¾ç¢ºåŠƒç·šé€£å‹•
           const checkLines = () => {
    // mlBox æ˜¯é‚£å€‹è¼¸å…¥æ•¸å­—çš„æ ¼å­
    // mlBox.parentElement å°±æ˜¯åŒ…ä½å®ƒçš„ã€Œå¤–æ®¼ã€
    const parent = mlBox.parentElement; 

    // å¦‚æœã€Œç™¾ä½è¼”åŠ©æ ¼ã€æœ‰å¡«æ±è¥¿ï¼Œå°±åœ¨ã€Œå¤–æ®¼ã€è²¼ä¸Šç™¾ä½æ–œç·šæ¨™ç±¤
    parent.classList.toggle('strike-hundreds', (up10.value !== "" || mc100.value !== ""));
    
    // å¦‚æœã€Œåä½è¼”åŠ©æ ¼ã€æœ‰å¡«æ±è¥¿ï¼Œå°±åœ¨ã€Œå¤–æ®¼ã€è²¼ä¸Šåä½æ–œç·šæ¨™ç±¤
    parent.classList.toggle('strike-tens', (mc1.value !== ""));    
};

            [up100, up10, mc100, mc10, mc1].forEach(h => {
                if(h) h.oninput = checkLines;
            });

            correctData["carry-box"] = l1 - 1;
        } else {
            // åŠ æ³•ï¼šä¸åŠƒç·šï¼Œä½†ä¿ç•™è¼”åŠ©æ ¼è®“å­¸ç”Ÿå¡«é€²ä½
            [up100, up10, mc1].forEach(el => { if(el) el.style.display = 'none'; });
            lBox.classList.remove('strike-l');
            mlBox.classList.remove('strike-hundreds', 'strike-tens', 'strike-ones');
        }
    }
}
function checkCalc() {
    let ok = true;
    // å®šç¾©å“ªäº›æ ¼æ˜¯ã€Œå¿…å¡«ä¸”è¦å°ã€çš„æ­£å¼ç­”æ¡ˆ
    const finalKeys = ['ansL1', 'ansMl1', 'ansL2', 'ansMl2', 'finalL', 'finalMl'];
    
    // 1. åªæª¢æŸ¥é€™ 6 æ ¼
    finalKeys.forEach(key => {
        let el = document.getElementById(key);
        if (el) {
            if (parseInt(el.value || 0) === correctData[key]) {
                el.style.borderColor = "var(--success)";
            } else {
                el.style.borderColor = "var(--error)";
                ok = false;
            }
        }
    });

    // 2. è¼”åŠ©æ ¼çš„éƒ¨åˆ†ï¼šæˆ‘å€‘è®“å®ƒã€Œæœ‰å°å°±è®Šç¶ ï¼Œæ²’å°ä¹Ÿä¸ç®—éŒ¯ã€
    const assistKeys = ['carry-box', 'ml-upper-100', 'ml-upper-10', 'ml-carry-100', 'ml-carry-10', 'ml-carry-1'];
    assistKeys.forEach(key => {
        let el = document.getElementById(key);
        if (el && el.value !== "") { // å­¸ç”Ÿæœ‰å¡«æ‰æª¢æŸ¥
            if (parseInt(el.value) === correctData[key]) {
                el.style.borderColor = "var(--success)";
            } else {
                // å¦‚æœå¡«éŒ¯ï¼Œå¯ä»¥çµ¦å€‹æ·¡æ·¡çš„æ©˜è‰²æé†’ï¼Œä½†ä¸è¦è®“ ok = false
                el.style.borderColor = "var(--secondary)"; 
            }
        }
    });

    processResult(ok, 'calc');
}
    function processResult(isCorrect, mode) {
        if (isFirstTry) {
            stats.total++; 
            if (isCorrect) stats.perfect++;
            isFirstTry = false;
            updateStats();
        }
        let fb = document.getElementById('feedback');
        if (isCorrect) {
            fb.innerText = "â­• æ­£ç¢ºï¼"; fb.style.color = "var(--success)";
            document.getElementById(mode + '-next').style.display = 'inline-block';
            document.getElementById(mode + '-check').style.display = 'none';
        } else {
            fb.innerText = "âŒ å†æª¢æŸ¥çœ‹çœ‹ï¼"; fb.style.color = "var(--error)";
        }
    }

    function updateStats() {
        document.getElementById('stat-total').innerText = stats.total;
        document.getElementById('stat-perfect').innerText = stats.perfect;
        let acc = (stats.total === 0) ? 0 : Math.round((stats.perfect / stats.total) * 100);
        document.getElementById('stat-accuracy').innerText = acc;
    }

    function getSimpleNums(isAdd) {
        let a = "", b = "";
        for(let i=0; i<3; i++) {
            let d1 = r(0, 9), d2;
            if (isAdd) d2 = r(0, 9 - d1); else d2 = r(0, d1);
            a += d1; b += d2;
        }
        return [parseInt(a), parseInt(b)];
    }

    function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
</script>
</body>
</html>
